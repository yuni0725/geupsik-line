# Geupsik Line Detection API

This API converts the original command-line detection system into a web service that can be controlled and monitored remotely.

## Features

- RESTful API endpoints for controlling detection
- Background processing with thread-safe operations
- Real-time status monitoring
- Configuration management
- Image and log retrieval
- Web interface for testing

## Installation

1. Install dependencies:

```bash
pip install fastapi uvicorn opencv-python ultralytics python-multipart pydantic
```

Or use the project dependencies:

```bash
pip install -e .
```

## Usage

### Starting the API Server

```bash
python api.py
```

The server will start on `http://localhost:8000`

### API Documentation

Once running, visit:

- Interactive docs: `http://localhost:8000/docs`
- Alternative docs: `http://localhost:8000/redoc`

### Web Interface

Open `web_interface.html` in your browser to use the visual interface.

## API Endpoints

### Control Endpoints

- **POST /start** - Start detection system
- **POST /stop** - Stop detection system
- **GET /status** - Get current system status

### Configuration

- **GET /config** - Get current configuration
- **POST /config** - Update configuration

### Data Retrieval

- **GET /logs** - Get all detection results
- **GET /images** - List available detection images
- **GET /image/{timestamp}** - Download specific image

## Example Usage

### Using curl

```bash
# Start detection
curl -X POST http://localhost:8000/start

# Check status
curl http://localhost:8000/status

# Get logs
curl http://localhost:8000/logs

# Stop detection
curl -X POST http://localhost:8000/stop
```

### Using Python

```python
import requests

# Start detection
response = requests.post("http://localhost:8000/start")
print(response.json())

# Monitor status
status = requests.get("http://localhost:8000/status").json()
print(f"Running: {status['is_running']}")
print(f"Phase: {status['current_phase']}")

# Get detection results
logs = requests.get("http://localhost:8000/logs").json()
print(f"Found {len(logs)} detections")
```

### Configuration Options

```json
{
  "video_source": "0", // "0" for webcam, or IP camera URL
  "wait_duration": 10, // Wait time between captures (seconds)
  "stillness_threshold": 30, // Pixel movement threshold for confirmation
  "capture_frames": 10 // Number of frames to analyze
}
```

## Response Models

### DetectionStatus

```json
{
  "is_running": true,
  "current_phase": "waiting",
  "time_remaining": 8,
  "total_detections": 5,
  "last_detection": "20240115-120935"
}
```

### DetectionResult

```json
{
  "timestamp": "20240115-120935",
  "x_coordinate": 245,
  "confidence": 0.87,
  "image_path": "results/confirmed_target_image_20240115-120935.jpg"
}
```

## Development

### Testing the Client

Run the example client:

```bash
python example_client.py
```

### Files Structure

- `api.py` - Main API server
- `main.py` - Original command-line version
- `example_client.py` - Example API client
- `web_interface.html` - Web interface for testing
- `results/` - Detection results and images

## Notes

- The API maintains compatibility with the original detection logic
- Detection runs in a background thread to avoid blocking API responses
- Configuration can only be updated when detection is not running
- All original CSV logging and image saving functionality is preserved
- The system automatically adjusts wait times based on detection success (30s after success, 5s after failure)

## Troubleshooting

1. **Camera access errors**: Ensure your camera is not being used by another application
2. **Port already in use**: Stop other services on port 8000 or change the port in `api.py`
3. **Missing dependencies**: Install all required packages using pip
4. **CORS issues**: The API allows all origins by default for development

### Generated by claude-4-sonnet
